<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Payment Integration</title>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe.js -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group input {
            padding: 10px;
            font-size: 16px;
            width: 100%;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>

<h2>Stripe Payment</h2>

<!-- Payment Form -->
<form id="payment-form">
    <div class="form-group">
        <label for="packageId">Package ID:</label>
        <input type="text" id="packageId" value="12345" required>
    </div>
    <div class="form-group">
        <label for="amount">Amount (in smallest currency unit, e.g., cents):</label>
        <input type="number" id="amount" value="1000" required>
    </div>
    <div class="form-group">
        <label for="card-element">Card Information:</label>
        <div id="card-element"><!-- Stripe's card element will go here --></div>
    </div>

    <div id="card-errors" class="error"></div>

    <button type="submit">Submit Payment</button>
</form>

<div id="payment-status"></div>

<script>
    // Initialize Stripe with your publishable key
    const stripe = Stripe('pk_test_51Pu8rkP6gWwO93XCdyyKBxRRGDuP61bc2e4C0Ci8u0mjHFQlm6ffZJbLiM582pweNTyv0dzipbaLZ1TenJ4kXpP800sMofcbVS'); // Replace with your Stripe publishable key
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    // Handle card element errors
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const packageId = document.getElementById('packageId').value;
        const amount = document.getElementById('amount').value;

        // Step 1: Create a payment intent by calling your backend API
        const response = await fetch('http://localhost:5000/api/payments/create-payment-intent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY2ZGUxMTIzZjdkY2RlY2Y2OGUzODY3MyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzI2MjUxNjA0LCJleHAiOjE3Mjg4NDM2MDR9.QrS09qsicLAJ_fLicu3ofBMnViQzbJMfNo7r-lMrFz4' // Add your authorization token here
            },
            body: JSON.stringify({
                amount: parseInt(amount, 10),
                packageId: packageId,
                currency: 'aed'
            })
        });

        const data = await response.json();

        if (!data.success) {
            document.getElementById('payment-status').textContent = `Error: ${data.error}`;
            return;
        }

        const clientSecret = data.clientSecret;

        // Step 2: Confirm the payment on the client side
        const { paymentIntent, error } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    // Optionally, add additional billing details here
                },
            }
        });

        if (error) {
            // Handle payment errors
            document.getElementById('payment-status').textContent = `Payment failed: ${error.message}`;
        } else if (paymentIntent.status === 'succeeded') {
            // Step 3: Store the payment information in your database
            const paymentResponse = await fetch('http://localhost:5000/api/payments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer YOUR_AUTH_TOKEN' // Add your authorization token here
                },
                body: JSON.stringify({
                    packageId: packageId,
                    amount: amount,
                    transactionId: paymentIntent.id,
                    paymentMethod: 'card'
                })
            });

            const paymentData = await paymentResponse.json();

            if (paymentData.success) {
                document.getElementById('payment-status').textContent = `Payment succeeded! Transaction ID: ${paymentIntent.id}`;
            } else {
                document.getElementById('payment-status').textContent = `Payment succeeded, but failed to store payment data: ${paymentData.error}`;
            }
        }
    });
</script>
</body>
</html>
